/*! Fabrik */

define(["jquery","fab/list-plugin"],function(e,t){var n=new Class({initialize:function(){this.updates={}},addFilter:function(e,t){this.updates[e]||(this.updates[e]=[]),this.updates[e].push(t)},onSumbit:function(){this.updates.date&&this.updates.date.each(function(e){e.onSubmit()})}});return new Class({Extends:t,initialize:function(e){if(this.parent(e),this.options.userSelect){var t="filter_update_col"+this.options.ref+"_"+this.options.renderOrder;Fabrik[t]=new n,this.makeUpdateColWindow()}},buttonAction:function(){this.options.userSelect?this.win.open():this.list.submit("list.doPlugin")},makeUpdateColWindow:function(){var o,d,l,u=this;u.windowopts={id:"update_col_win_"+u.options.ref+"_"+u.options.renderOrder,title:Joomla.JText._("PLG_LIST_UPDATE_COL_UPDATE"),loadMethod:"html",content:u.options.form,width:400,destroy:!1,height:300,onOpen:function(){this.fitToContent(!1)},onContentLoaded:function(e){var i=document.id("update_col"+u.options.ref+"_"+u.options.renderOrder);i.addEvent("click:relay(a.add)",function(e,t){var n;e.preventDefault(),"none"===(n=t.getParent("thead")?i.getElements("tbody tr").getLast():t.getParent("tr")).getStyle("display")?((o=n.getElements("td"))[0].getElement("select").selectedIndex=0,o[1].empty(),n.show()):(d=n.clone(),(o=d.getElements("td"))[0].getElement("select").selectedIndex=0,o[1].empty(),d.inject(n,"after"))}),i.addEvent("click:relay(a.delete)",function(e,t){e.preventDefault();var n=i.getElements("tbody tr");1===n.length?n.getLast().hide():t.getParent("tr").destroy()}),i.addEvent("change:relay(select.key)",function(e,t){var n=t.getParent("tbody").getElements(".update_col_elements");for(l=0;l<n.length;l++)if(n[l]!==t&&n[l].selectedIndex===t.selectedIndex)return void window.alert("This element has already been selected!");var i=t.options[t.selectedIndex],o=t.getParent("tr");Fabrik.loader.start(o);var d=o.getElement("td.update_col_value"),a=t.get("value"),r=i.get("data-plugin"),s=i.get("data-id");new Request.HTML({url:"index.php?option=com_fabrik&task=list.elementFilter&format=raw",update:d,data:{element:a,id:u.options.listid,elid:s,plugin:r,counter:0,listref:u.options.ref,context:"visualization",parentView:"update_col"+u.options.ref+"_"+u.options.renderOrder,fabrikIngoreDefaultFilterVal:1},onComplete:function(){Fabrik.loader.stop(o),u.win.fitToContent(!1)}}).send()}),i.getElement("input[type=button]").addEvent("click",function(e){e.stop(),Fabrik["filter_update_col"+u.options.ref+"_"+u.options.renderOrder].onSumbit();var t=document.id("listform_"+u.options.ref);new Element("input",{type:"hidden",value:i.toQueryString(),name:"fabrik_update_col"}).inject(t,"bottom"),u.list.submit("list.doPlugin")})}},u.win=Fabrik.getWindow(u.windowopts),u.win.close()}})});